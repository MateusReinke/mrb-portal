<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Portal MRB Automações</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #0f172a;
    color: white;
}

header {
    background: #111827;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

h1 {
    margin: 0;
}

button {
    padding: 8px 14px;
    border: none;
    cursor: pointer;
    border-radius: 6px;
    font-weight: bold;
}

.login-btn {
    background: #24292e;
    color: white;
}

.edit-btn {
    background: #2563eb;
    color: white;
}

.save-btn {
    background: #16a34a;
    color: white;
}

.grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
    padding: 30px;
}

.card {
    background: #1e293b;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

.card h3 {
    margin-top: 0;
}

textarea {
    width: 100%;
    height: 100px;
    margin-top: 10px;
    background: #0f172a;
    color: white;
    border: 1px solid #334155;
    padding: 8px;
    border-radius: 6px;
}
</style>
</head>

<body>

<header>
    <h1>Portal MRB Automações</h1>
    <div>
        <button id="loginBtn" class="login-btn" onclick="loginGithub()">Login com GitHub</button>
        <button id="editBtn" class="edit-btn" style="display:none;" onclick="toggleEdit()">Editar</button>
    </div>
</header>

<div class="grid" id="portalGrid"></div>

<script>
let isAdmin = false;
let editMode = false;
let dataCache = [];

// Login via GitHub
function loginGithub() {
    window.location.href = "/auth/github";
}

// Carregar conteúdo
async function loadContent() {
    const res = await fetch("/content");
    const data = await res.json();
    dataCache = data;
    renderCards();
}

// Renderizar cards
function renderCards() {
    const grid = document.getElementById("portalGrid");
    grid.innerHTML = "";

    dataCache.forEach((item, index) => {
        const card = document.createElement("div");
        card.className = "card";

        if (editMode) {
            card.innerHTML = `
                <h3>${item.title}</h3>
                <textarea onchange="updateContent(${index}, this.value)">${item.content}</textarea>
            `;
        } else {
            card.innerHTML = `
                <h3>${item.title}</h3>
                <p>${item.content}</p>
            `;
        }

        grid.appendChild(card);
    });

    if (editMode) {
        const saveButton = document.createElement("button");
        saveButton.className = "save-btn";
        saveButton.innerText = "Salvar Alterações";
        saveButton.style.margin = "30px";
        saveButton.onclick = saveAll;
        grid.appendChild(saveButton);
    }
}

function toggleEdit() {
    editMode = !editMode;
    renderCards();
}

function updateContent(index, value) {
    dataCache[index].content = value;
}

async function saveAll() {
    await fetch("/content", {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(dataCache)
    });

    alert("Alterações salvas com sucesso!");
    editMode = false;
    renderCards();
}

// Verificar sessão
async function checkAuth() {
    const res = await fetch("/me");
    if (res.ok) {
        isAdmin = true;
        document.getElementById("loginBtn").style.display = "none";
        document.getElementById("editBtn").style.display = "inline-block";
    }
}

loadContent();
checkAuth();
</script>

</body>
</html>
